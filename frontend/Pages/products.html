<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>DropShipX ‚Äî Products</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <link href="../css/style.css" rel="stylesheet" />
  </head>

  <body class="d-flex flex-column min-vh-100">
    <header class="navbar navbar-expand-lg bg-white border-bottom sticky-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">DropShipX</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navMenu"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <nav id="navMenu" class="collapse navbar-collapse">
          <ul class="navbar-nav ms-auto align-items-lg-center">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Inicial</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="products.html">Produtos</a>
            </li>

            <li class="nav-item">
              <a class="nav-link fw-bold text-primary" href="orders.html"
                >Meus Pedidos</a
              >
            </li>

            <li class="nav-item">
              <a class="nav-link" href="about.html">Sobre</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="contact.html">Contacto</a>
            </li>
            <li class="nav-item ms-lg-2">
              <a class="btn btn-primary" href="cart.html">Carrinho</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container py-5">
      <h1 class="h3 mb-4">Cat√°logo de Produtos</h1>

      <div id="product-list" class="row g-4">
        <div class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">A carregar...</span>
          </div>
          <p class="mt-2 text-muted">A ligar √† Base de Dados...</p>
        </div>
      </div>
    </main>

    <footer class="bg-light border-top py-4 mt-auto text-center">
      <div class="container">¬© <span id="year"></span> DropShipX</div>
      <div class="social-icons d-flex justify-content-center gap-3 mt-3">
        <a href="#" target="_blank"
          ><i class="bi bi-instagram" style="font-size: 28px"></i
        ></a>
        <a href="#" target="_blank"
          ><i class="bi bi-facebook" style="font-size: 28px"></i
        ></a>
        <a href="#" target="_blank"
          ><i class="bi bi-linkedin" style="font-size: 28px"></i
        ></a>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="../js/app.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const productList = document.getElementById("product-list");

        // 1. Verificar Seguran√ßa
        if (!isLoggedIn()) {
          productList.innerHTML = `
            <div class="col-12 text-center">
              <div class="alert alert-warning py-4">
                <h4>Acesso Restrito üîí</h4>
                <p>Tens de fazer <a href="login.html" class="fw-bold">Login</a> para ver o nosso cat√°logo.</p>
              </div>
            </div>`;
          return;
        }

        try {
          // 2. Fazer o Pedido √† API
          const response = await fetch(`${API_URL}/products`, {
            method: "GET",
            headers: {
              Authorization: `Bearer ${getToken()}`,
              "Content-Type": "application/json",
            },
          });

          if (!response.ok)
            throw new Error("N√£o foi poss√≠vel carregar os produtos.");

          const products = await response.json();
          productList.innerHTML = "";

          if (products.length === 0) {
            productList.innerHTML =
              "<p class='text-center'>Nenhum produto encontrado.</p>";
            return;
          }

          // 3. Desenhar os Cart√µes
          products.forEach((p) => {
            // --- NOVA L√ìGICA DE IMAGEM ---
            // Define uma imagem padr√£o (fallback)
            let imgPath = "../assets/img/backpack.jpg";

            // Se a BD trouxer um nome de ficheiro na coluna 'imageUrl'
            // Montamos o caminho completo: ../assets/img/ + NomeQueVemDaBD
            if (p.imageUrl) {
              imgPath = `../assets/img/${p.imageUrl}`;
            }

            const cardHtml = `
              <div class="col-md-4">
                <article class="card h-100 shadow-sm hover-effect">
                  
                  <img src="${imgPath}" class="card-img-top" alt="${p.name}" 
                       style="height: 250px; object-fit: contain; padding: 10px; background: #f8f9fa;">
                  
                  <div class="card-body d-flex flex-column">
                    <h2 class="h5">${p.name}</h2>
                    
                    <p class="text-muted small mb-3 flex-grow-1">
                      ${p.description || "Descri√ß√£o indispon√≠vel."} <br>
                      <span class="badge bg-light text-dark border mt-2">SKU: ${
                        p.sku
                      }</span>
                    </p>
                    
                    <div class="d-flex justify-content-between align-items-center mt-3">
                      <strong class="fs-4 text-primary">‚Ç¨${p.price.toFixed(
                        2
                      )}</strong>
                      
                      <button class="btn btn-primary btn-sm" 
                              data-add-to-cart 
                              data-id="${p.id}" 
                              data-name="${p.name}" 
                              data-price="${p.price}">
                        Add to Cart
                      </button>
                    </div>

                    <div class="mt-3 pt-2 border-top">
                        <button onclick="checkStock(${
                          p.id
                        })" class="btn btn-outline-secondary btn-sm w-100" style="font-size: 0.8rem;">
                          <i class="bi bi-box-seam"></i> Verificar Stock (Fornecedor)
                        </button>
                        <small id="stock-msg-${
                          p.id
                        }" class="d-block mt-1 text-center fst-italic" style="font-size: 0.75rem; min-height: 1.2em;"></small>
                    </div>
                  </div>
                </article>
              </div>
            `;
            productList.innerHTML += cardHtml;
          });
        } catch (err) {
          console.error(err);
          productList.innerHTML = `<div class="alert alert-danger">Erro de liga√ß√£o: ${err.message}</div>`;
        }
      });

      // Fun√ß√£o Stock (Inalterada)
      async function checkStock(id) {
        const msgEl = document.getElementById(`stock-msg-${id}`);
        msgEl.textContent = "A contactar fornecedor...";
        msgEl.className = "d-block mt-1 text-center text-muted";

        try {
          const res = await fetch(`${API_URL}/products/${id}/stock`, {
            headers: { Authorization: `Bearer ${getToken()}` },
          });
          const data = await res.json();

          if (res.ok) {
            msgEl.textContent = `‚úÖ Stock: ${data.stockNoFornecedor} un. (Envio: ${data.envioEstimado})`;
            msgEl.className = "d-block mt-1 text-center text-success fw-bold";
          } else {
            msgEl.textContent = "‚ùå Indispon√≠vel.";
            msgEl.className = "d-block mt-1 text-center text-danger";
          }
        } catch (e) {
          msgEl.textContent = "Erro de rede.";
        }
      }
    </script>
  </body>
</html>
